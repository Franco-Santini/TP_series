---
format: 
  pdf:
    fig-pos: "H"
    tbl-cap-location: bottom
lang: es
echo: FALSE
message: FALSE
warning: FALSE
geometry:
  - top= 25mm
  - left= 20mm
  - right = 20mm
  - bottom = 25mm
  - heightrounded
header-includes:
  - \usepackage{ragged2e}
  - \usepackage{hyperref}
  - \usepackage{float}
  - \floatplacement{table}{H}
---

::: {.center data-latex=""}

\vspace{3cm}

```{r logo facultad, echo=F, include = T, out.width= "60%"}
knitr::include_graphics("logounr.png")
```

\pagenumbering{gobble}

\vspace{5cm}

\Large
**LICENCIATURA EN ESTADÍSTICA**

\vspace{1cm}

\Large
**Trabajo Práctico**


\vspace{0.3cm}
\large

*"Evaluación de las Tendencias de Ventas Mensuales en una Empresa de Logística*

\vspace{0.1cm}

*Mediante Series de Tiempo"*

\vspace{8cm}

\large

**Autor: Franco Santini**

**Docentes: Fernanda Mendez - Facundo Sigal**

**2024**
\normalsize
\newpage
\hypersetup{linkcolor = black}
\tableofcontents


\newpage
\pagenumbering{arabic}

:::

\newpage

```{r librerias}
library(dplyr) # Manejo de datos
library(lubridate) # Manejo de fechas
library(ggplot2) # Gráficos
library(MASS) # Transformación Box-Cox
library(readxl) # Leer archivos excel
```

# Introducción

Narrar una breve introducción acerca del problema en estudio|

## Análisis descriptivo

```{r carga datos 2}
datos2 <- read_excel("Datos/empresa_casilda.xlsx")
datos_trabajo_2 <- datos2

datos_trabajo_2$`Año/Mes` <- ym(datos_trabajo_2$`Año/Mes`) # Pasamos a formato fecha
datos_trabajo_2$Año <- factor(datos_trabajo_2$Año)
```


```{r grafico serie 2}
datos_empresa_1 <- datos_trabajo_2 |> 
  group_by(`Año/Mes`, Distribuidora) |> 
  filter(Distribuidora == "EMPRESA 1") |> 
  summarise(
    Cantidad_total_HL = sum(`Cantidad Total en HL`)
  ) |> 
  ungroup()

datos_empresa_1 |> 
  ggplot() +
  aes(x = `Año/Mes`, y = Cantidad_total_HL) +
  geom_line() +
  geom_point(size = 1.5, color = "dodgerblue2") +
  scale_y_continuous(breaks = seq(6000, 20000, 2000)) +
  scale_x_date(breaks = scales::date_breaks("1 year"), labels = scales::date_format("%Y")) +
  labs(x = "Fecha", y = "Cantidad total vendida (HL)") +
  theme_bw()
```

Parece haber un comportamiento estacional

```{r grafico estacional 2}
datos_empresa_1 |> 
  mutate(anio = factor(year(`Año/Mes`)),
         mes = factor(month(`Año/Mes`))) |> 
  filter(anio != 2024) |> 
  ggplot() +
  aes(x = mes, y = Cantidad_total_HL, group = anio, color = anio) +
  geom_line() +
  scale_y_continuous(breaks = seq(6000, 20000, 2000)) +
  labs(x = "Mes", y = "Cantidad total vendida (HL)", color = "Año") +
  theme_bw()
```

Gráfico de autocorrelación

```{r grafico autocorrelacion 2}
autocorrelacion_2 <- acf(datos_empresa_1$Cantidad_total_HL, lag.max = 80, plot = F)
datos_autocorrelacion <- data.frame(
  acf = autocorrelacion_2$acf,
  lag = autocorrelacion_2$lag
)

alpha <- 0.95
conf.lims <- c(-1,1)*qnorm((1 + alpha)/2)/sqrt(autocorrelacion_2$n.used)


datos_autocorrelacion |> 
  ggplot() +
  aes(x = lag, y = acf) +
  geom_segment(aes(x = lag, xend = lag, y = 0, yend = acf), linewidth = 1) +
  geom_point(size = 1.5, color = "dodgerblue2") +
  geom_hline(yintercept=conf.lims, lty=2, col='blue') +
  geom_hline(yintercept = 0) +
  scale_x_continuous(breaks = seq(0, 80, 4)) +
  labs(x = "Rezago", y = expression(rho[k])) +
  theme_bw()
```

```{r grafico de autocorrelacion parcial 2}
pautocorrelacion_2 <- pacf(datos_empresa_1$Cantidad_total_HL, lag.max = 80, plot = F)
datos_pautocorrelacion <- data.frame(
  pacf = pautocorrelacion_2$acf,
  lag = pautocorrelacion_2$lag
)

alpha <- 0.95
conf.lims2 <- c(-1,1)*qnorm((1 + alpha)/2)/sqrt(pautocorrelacion_2$n.used)

datos_pautocorrelacion |> 
  ggplot() +
  aes(x = lag, y = pacf) +
  geom_segment(aes(x = lag, xend = lag, y = 0, yend = pacf), linewidth = 1) +
  geom_point(size = 1.5, color = "dodgerblue2") +
  geom_hline(yintercept=conf.lims2, lty=2, col='blue') +
  geom_hline(yintercept = 0) +
  scale_x_continuous(breaks = seq(0, 80, 4)) +
  labs(y = expression(phi[kk]), x = "Rezago") +
  theme_bw()
```

### Analisis de dispersion

```{r boxplot por año 2}
datos_empresa_1 |> 
  mutate(anio = factor(year(`Año/Mes`))) |> 
  filter(anio != 2024) |> 
  ggplot() +
  aes(x = anio, y = Cantidad_total_HL) +
  geom_boxplot(fill = "dodgerblue2") +
  scale_y_continuous(breaks = seq(6000, 20000, 2000)) +
  labs(x = "Año", y = "Cantidad total vendida (HL)") +
  theme_bw()


```

Parece haber variabilidad constante, un poco más alta en el año 2020.

## Transformación de la serie

```{r transformacion box-cox}
bc_transf <- boxcox(lm(data = datos_empresa_1, Cantidad_total_HL ~ 1), plotit = F)

# Grafico de la transformacion box cox
data.frame(
  x = bc_transf$x,
  y = bc_transf$y
) |> 
  ggplot() +
  aes(x = x, y = y) +
  geom_line() +
  geom_segment(x = bc_transf$x[which.max(bc_transf$y)], xend = bc_transf$x[which.max(bc_transf$y)], y = -76, yend = bc_transf$y[bc_transf$x == bc_transf$x[which.max(bc_transf$y)]], lty = 2) +
  scale_x_continuous(breaks = seq(-2, 2, 0.5)) +
  labs(x = expression(lambda), y = "Log-verosimilitud") +
  theme_bw()
```

Otro análisis que sería propicio de realizar, seria calcular el Coeficiente de Variación, bajo distintas
transformaciones de Box-Cox, con el fin de poder evaluar si una transformación de potencia seria
propicia para nuestra serie.

```{r transformacion box-cox 2}
# data.frame(
#   lambda = bc_transf$x,
#   y = bc_transf$y
# ) |> 
#   filter(lambda %in% c(-2, -1, -0.5, 0, 0.5, 1, 2))
# Con esto solo aplicamos las transformaciones 
# lambda = 2 implica y^2
# lambda = 1 implica y (no se transforma)
# lambda = 0.5 implica sqrt(y)
# lambda = 0 implica ln(y)
# lambda = -0.5 implica 1/sqrt(y)
# lambda = -1 implica 1/y
# lambda = -2 implica 1/y^2

y_lambda2 <- datos_empresa_1$Cantidad_total_HL^2
y_lambda05 <- sqrt(datos_empresa_1$Cantidad_total_HL)
y_lambda0 <- log(datos_empresa_1$Cantidad_total_HL)
y_lambda.05 <- 1/sqrt(datos_empresa_1$Cantidad_total_HL)
y_lambda.1 <- 1/datos_empresa_1$Cantidad_total_HL
y_lambda.2 <- 1/(datos_empresa_1$Cantidad_total_HL^2)

bc <- data.frame(
  lambda = c(-2, -1, -0.5, 0, 0.5, 1, 2),
  Coeficiente_de_variacion = c(sd(y_lambda.2)/mean(y_lambda.2), sd(y_lambda.1)/mean(y_lambda.1), sd(y_lambda.05)/mean(y_lambda.05), sd(y_lambda0)/mean(y_lambda0), sd(y_lambda05)/mean(y_lambda05), sd(datos_empresa_1$Cantidad_total_HL)/mean(datos_empresa_1$Cantidad_total_HL), sd(y_lambda2)/mean(y_lambda2))
  )

kableExtra::kable(bc, digits = 4)
```

Observando la tabla, es apropiado aplicar la transformacion $y^{(\lambda)} = ln(y)$.

### Análisis descriptivo de la serie transformada

```{r datos transformados}
datos_empresa_transformados <- datos_empresa_1 |> 
  mutate(ln_y = log(datos_empresa_1$Cantidad_total_HL),
         anio = factor(year(`Año/Mes`)),
         mes = factor(month(`Año/Mes`)))
```


```{r descriptivo serie transformada}
datos_empresa_transformados |> 
  ggplot() +
  aes(x = `Año/Mes`, y = ln_y) +
  geom_line() +
  geom_point(size = 1.5, color = "dodgerblue2") +
  scale_y_continuous(breaks = seq(8, 10, 0.2)) +
  scale_x_date(breaks = scales::date_breaks("1 year"), labels = scales::date_format("%Y")) +
  labs(x = "Fecha", y = "Log. natural de la cantidad total vendida (HL)") +
  theme_bw()
```
```{r descriptivo serie transformada 2}
datos_empresa_transformados |>
  filter(anio != 2024) |> 
  ggplot() +
  aes(x = mes, y = ln_y, group = anio, color = anio) +
  geom_line() +
  scale_y_continuous(breaks = seq(8, 10, 0.2)) +
  labs(x = "Mes", y = "Log. natural de la cantidad total vendida (HL)", color = "Año") +
  theme_bw()
```

```{r grafico de la fac serie transformada}
autocorrelacion_transf <- acf(datos_empresa_transformados$ln_y, lag.max = 80, plot = F)
datos_autocorrelacion_transf <- data.frame(
  acf = autocorrelacion_transf$acf,
  lag = autocorrelacion_transf$lag
)

alpha <- 0.95
conf.lims <- c(-1,1)*qnorm((1 + alpha)/2)/sqrt(autocorrelacion_transf$n.used)


datos_autocorrelacion_transf |> 
  ggplot() +
  aes(x = lag, y = acf) +
  geom_segment(aes(x = lag, xend = lag, y = 0, yend = acf), linewidth = 1) +
  geom_point(size = 1.5, color = "dodgerblue2") +
  geom_hline(yintercept=conf.lims, lty=2, col='blue') +
  geom_hline(yintercept = 0) +
  scale_x_continuous(breaks = seq(0, 80, 4)) +
  labs(x = "Rezago", y = expression(rho[k])) +
  theme_bw()
```

```{r grafico de la facp serie transformada}
pautocorrelacion_trans <- pacf(datos_empresa_transformados$ln_y, lag.max = 80, plot = F)
datos_pautocorrelacion_trans <- data.frame(
  pacf = pautocorrelacion_trans$acf,
  lag = pautocorrelacion_trans$lag
)

alpha <- 0.95
conf.lims2 <- c(-1,1)*qnorm((1 + alpha)/2)/sqrt(pautocorrelacion_trans$n.used)

datos_pautocorrelacion_trans |> 
  ggplot() +
  aes(x = lag, y = pacf) +
  geom_segment(aes(x = lag, xend = lag, y = 0, yend = pacf), linewidth = 1) +
  geom_point(size = 1.5, color = "dodgerblue2") +
  geom_hline(yintercept=conf.lims2, lty=2, col='blue') +
  geom_hline(yintercept = 0) +
  scale_x_continuous(breaks = seq(0, 80, 4)) +
  labs(y = expression(phi[kk]), x = "Rezago") +
  theme_bw()
```

```{r descriptivo serie transformada 3}
datos_empresa_transformados |> 
  filter(anio != 2024) |> 
  ggplot() +
  aes(x = anio, y = ln_y) +
  geom_boxplot(fill = "dodgerblue2") +
  scale_y_continuous(breaks = seq(8, 10, 0.2)) +
  labs(x = "Año", y = "Log. natural de la cantidad total vendida (HL)") +
  theme_bw()
```

Por último, hacemos el análisis de tendencia de la serie para ver si hay alguna tendencia alrededor de la media

```{r tendencia de la serie transformada}
tabla_promedios <- datos_empresa_transformados |> 
  group_by(anio) |> 
  summarise(media_anio = mean(ln_y)) |> 
  ungroup()

media_gral <- datos_empresa_transformados |> 
  filter(anio != 2024) |> 
  summarise(media = mean(ln_y))

tabla_promedios |> 
  filter(anio != 2024) |> 
  ggplot() +
  geom_line(aes(x = anio, y = media_anio, group = 1)) +
  geom_point(aes(x = anio, y = media_anio)) +
  geom_hline(yintercept = media_gral$media, lty = 2) +
  labs(x = "Año", y = "Promedio del log. natural de la cantidad total vendida (HL)") +
  theme_bw()
```



