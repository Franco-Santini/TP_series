---
format: 
  pdf:
    fig-pos: "H"
    tbl-cap-location: bottom
lang: es
echo: FALSE
message: FALSE
warning: FALSE
geometry:
  - top= 25mm
  - left= 20mm
  - right = 20mm
  - bottom = 25mm
  - heightrounded
header-includes:
  - \usepackage{ragged2e}
  - \usepackage{hyperref}
  - \usepackage{float}
  - \floatplacement{table}{H}
---

::: {.center data-latex=""}

\vspace{3cm}

```{r logo facultad, echo=F, include = T, out.width= "60%"}
knitr::include_graphics("logounr.png")
```

\pagenumbering{gobble}

\vspace{5cm}

\Large
**LICENCIATURA EN ESTADÍSTICA**

\vspace{1cm}

\Large
**Trabajo Práctico**


\vspace{0.3cm}
\large

*"Evaluación de las Tendencias de Ventas Mensuales en una Empresa de Logística Mediante Series de Tiempo"*

\vspace{8cm}

\large

**Autor: Franco Santini**

**Docentes: Fernanda Mendez - Facundo Sigal**

**2024**
\normalsize
\newpage
\hypersetup{linkcolor = black}
\tableofcontents


\newpage
\pagenumbering{arabic}

:::

\newpage

```{r librerias}
library(dplyr) # Manejo de datos
library(lubridate) # Manejo de fechas
library(ggplot2) # Gráficos
library(MASS) # Transformación Box-Cox
library(readxl) # Leer archivos excel
```

# Introducción

Narrar una breve introducción acerca del problema en estudio|

## Análisis descriptivo

```{r carga datos 2}
datos2 <- read_excel("Datos/empresa_casilda.xlsx")
datos_trabajo_2 <- datos2

datos_trabajo_2$`Año/Mes` <- ym(datos_trabajo_2$`Año/Mes`) # Pasamos a formato fecha
datos_trabajo_2$Año <- factor(datos_trabajo_2$Año)
```


```{r grafico serie 2}
datos_empresa_1 <- datos_trabajo_2 |> 
  group_by(`Año/Mes`, Distribuidora) |> 
  filter(Distribuidora == "EMPRESA 1") |> 
  summarise(
    Cantidad_total_HL = sum(`Cantidad Total en HL`)
  ) |> 
  ungroup()

datos_empresa_1 |> 
  ggplot() +
  aes(x = `Año/Mes`, y = Cantidad_total_HL) +
  geom_line() +
  geom_point(size = 1.5, color = "dodgerblue2") +
  labs(x = "Fecha", y = "Cantidad total vendido (HL)") +
  theme_bw()
```

Parece haber un comportamiento estacional

```{r grafico estacional 2}
datos_empresa_1 |> 
  mutate(anio = factor(year(`Año/Mes`)),
         mes = factor(month(`Año/Mes`))) |> 
  ggplot() +
  aes(x = mes, y = Cantidad_total_HL, group = anio, color = anio) +
  geom_line() +
  labs(x = "Mes", y = "Cantidad total vendido (HL)", color = "Año") +
  theme_bw()
```

```{r graficos estacionales subseries 2}
tabla_2 <- datos_empresa_1 |> 
  mutate(mes = factor(month(`Año/Mes`), labels = c("Ene", "Feb", "Mar", "Abr", "May", "Jun", "Jul", "Ago", "Sep", "Oct", "Nov", "Dic")),
         anio = factor(year(`Año/Mes`))) |> 
  group_by(mes) |> 
  summarise(media = mean(Cantidad_total_HL),
            anio,
            Cantidad_total_HL)

tabla_2 |> 
  ggplot() +
  aes(x = anio, y = Cantidad_total_HL, group = mes) +
  geom_line() +
  geom_hline(aes(yintercept = media), color = "blue") +
  facet_wrap(~mes) +
  theme_bw()

# Veo que hago con este gráfico, capaz lo saco.
```

Gráfico de autocorrelación

```{r grafico autocorrelacion 2}
autocorrelacion_2 <- acf(datos_empresa_1$Cantidad_total_HL, lag.max = 80, plot = F)
datos_autocorrelacion <- data.frame(
  acf = autocorrelacion_2$acf,
  lag = autocorrelacion_2$lag
)

alpha <- 0.95
conf.lims <- c(-1,1)*qnorm((1 + alpha)/2)/sqrt(autocorrelacion_2$n.used)


datos_autocorrelacion |> 
  ggplot() +
  aes(x = lag, y = acf) +
  geom_segment(aes(x = lag, xend = lag, y = 0, yend = acf), linewidth = 1) +
  geom_point(size = 1.5, color = "dodgerblue2") +
  geom_hline(yintercept=conf.lims, lty=2, col='blue') +
  geom_hline(yintercept = 0) +
  labs(x = "Rezago", y = expression(rho[k])) +
  theme_bw()
```

```{r grafico de autocorrelacion parcial 2}
pautocorrelacion_2 <- pacf(datos_empresa_1$Cantidad_total_HL, lag.max = 80, plot = F)
datos_pautocorrelacion <- data.frame(
  pacf = pautocorrelacion_2$acf,
  lag = pautocorrelacion_2$lag
)

alpha <- 0.95
conf.lims2 <- c(-1,1)*qnorm((1 + alpha)/2)/sqrt(pautocorrelacion_2$n.used)

datos_pautocorrelacion |> 
  ggplot() +
  aes(x = lag, y = pacf) +
  geom_segment(aes(x = lag, xend = lag, y = 0, yend = pacf), linewidth = 1) +
  geom_point(size = 1.5, color = "dodgerblue2") +
  geom_hline(yintercept=conf.lims2, lty=2, col='blue') +
  geom_hline(yintercept = 0) +
  labs(y = expression(phi[kk]), x = "Rezago") +
  theme_bw()
```

### Analisis de dispersion

```{r boxplot por año 2}
datos_empresa_1 |> 
  mutate(anio = factor(year(`Año/Mes`))) |> 
  filter(anio != 2024) |> 
  ggplot() +
  aes(x = anio, y = Cantidad_total_HL) +
  geom_boxplot(fill = "dodgerblue2") +
  labs(x = "Año", y = "Cantidad total vendido (HL)") +
  theme_bw()


```

Parece haber variabilidad constante, un poco más alta en el año 2020.

```{r transformacion box-cox}
bc_transf <- boxcox(lm(data = datos_empresa_1, Cantidad_total_HL ~ 1), plotit = F)

# Grafico de la transformacion box cox
data.frame(
  x = bc_transf$x,
  y = bc_transf$y
) |> 
  ggplot() +
  aes(x = x, y = y) +
  geom_line() +
  geom_segment(x = bc_transf$x[which.max(bc_transf$y)], xend = bc_transf$x[which.max(bc_transf$y)], y = -76, yend = bc_transf$y[bc_transf$x == bc_transf$x[which.max(bc_transf$y)]], lty = 2) +
  labs(x = expression(lambda), y = "Log-verosimilitud") +
  theme_bw()
```


